# Makefile to build the various Benchmarks
#
# SYNOPSIS:
#
#   make [all]  - makes everything.
#   make clean  - removes all files generated by make.
#
# Author: Rainer Keller, HS-Esslingen
#

# Please add bench_pipes.c yourself...
SOURCES=bench_rdtsc.c bench_signal.c bench_mmap.c bench_pipes.c
ifeq ($(OS),Linux)
    SOURCES+=bench_process_vm_readv.c
endif

BENCHMARKS=$(SOURCES:.c=)
PLOTABLE=plot_mmap plot_pipes
ifeq ($(OS),Linux)
    PLOTABLE+=plot_process_vm_readv
endif

CC=gcc
CFLAGS=-Wall -O2

all: $(BENCHMARKS) $(PLOTABLE)

clean:
	rm -f $(BENCHMARKS)

.c.o:
	$(CC) $(CFLAGS) -o $@ $<

plot: $(PLOTABLE)

$(PLOTABLE): $(BENCHMARKS)
	./$(@:plot_%=bench_%) \
		| tail -n +2 \
		| cut -f16,14 -d' ' \
		| sed "s/(//g" \
		| gnuplot -p -e "set logscale x 2; \
			set grid; \
			set xlabel 'Transfer Size (in Bytes)'; \
			set ylabel 'Speed (in MB/s)'; \
			plot '<cat' with linespoints title '${@:plot_%=%}' noenhanced";

.PHONY: all clean plot $(PLOTABLE)
